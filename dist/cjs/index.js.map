{"version":3,"file":"index.js","sources":["../../src/index.ts"],"sourcesContent":["import { Request, Response, NextFunction } from \"express\";\r\n\r\ntype FetchResult = { price: number; time: Date }[];\r\ntype LargestTimeDifference = {\r\n  largestDifference: number;\r\n  item1: Date;\r\n  item2: Date;\r\n};\r\ntype ResponseType = {\r\n  success: boolean;\r\n  error: null | string;\r\n  result: {\r\n    range: {\r\n      start: Date;\r\n      end: Date;\r\n    } | null;\r\n  };\r\n  timestamp: number;\r\n};\r\nfunction createHandler(ttl: number, fetchFunc: any) {\r\n  const cache: { [key: string]: ResponseType } = {};\r\n  let lastFetchTime: number = 0; // Time of last fetch\r\n\r\n  return async function (req: Request, res: Response, next: NextFunction) {\r\n    const id = parseInt(req.query.id as string);\r\n    if (!isNaN(id) && id > 0) {\r\n      if (cache[id] && Date.now() - cache[id].timestamp <= ttl) {\r\n        const { timestamp, ...responseWithoutTimestamp } = cache[id];\r\n        res.status(200).json(responseWithoutTimestamp);\r\n        return;\r\n      }\r\n      const result = await fetchFunc(id);\r\n\r\n      const filteredArray = getFilteredArray(result);\r\n      const timeDifferenceResult: LargestTimeDifference =\r\n        findLargestTimeDifference(sortByTime(filteredArray));\r\n      if (\r\n        timeDifferenceResult.largestDifference === 0 ||\r\n        filteredArray.length <= 1\r\n      ) {\r\n        let response = {\r\n          success: true,\r\n          error: null,\r\n          result: {\r\n            range: null,\r\n          },\r\n        };\r\n        cache[id] = { ...response, timestamp: Date.now() };\r\n        res.status(200).json(response);\r\n      } else {\r\n        let response = {\r\n          success: true,\r\n          error: null,\r\n          result: {\r\n            range: {\r\n              start: timeDifferenceResult.item1,\r\n              end: timeDifferenceResult.item2,\r\n            },\r\n          },\r\n        };\r\n        cache[id] = { ...response, timestamp: Date.now() };\r\n        res.status(200).json(response);\r\n      }\r\n    } else {\r\n      res.status(400).json({\r\n        success: false,\r\n        error: \"Something went wrong\",\r\n        result: null,\r\n      });\r\n    }\r\n  };\r\n}\r\n\r\nexport const getFilteredArray = (arr: FetchResult): FetchResult => {\r\n  const averagePrice =\r\n    arr.reduce(\r\n      (accumulator, currentItem) => accumulator + currentItem.price,\r\n      0\r\n    ) / arr.length;\r\n  return arr.filter((item) => item.price > averagePrice);\r\n};\r\n\r\nexport const sortByTime = (arr: FetchResult): FetchResult => {\r\n  return arr.sort((a, b) => a.time.getTime() - b.time.getTime());\r\n};\r\n\r\nexport const findLargestTimeDifference = (\r\n  arr: FetchResult\r\n): LargestTimeDifference => {\r\n  let largestDifference = 0;\r\n  let largestDifferenceItem1 = arr[0].time;\r\n  let largestDifferenceItem2 = arr[1].time;\r\n\r\n  for (let i = 1; i < arr.length; i++) {\r\n    const difference = arr[i].time.getTime() - arr[i - 1].time.getTime();\r\n    if (difference > largestDifference) {\r\n      largestDifference = difference;\r\n      largestDifferenceItem1 = arr[i - 1].time;\r\n      largestDifferenceItem2 = arr[i].time;\r\n    }\r\n  }\r\n\r\n  return {\r\n    largestDifference,\r\n    item1: largestDifferenceItem1,\r\n    item2: largestDifferenceItem2,\r\n  };\r\n};\r\n\r\nexport { createHandler };\r\nmodule.exports = createHandler;\r\n"],"names":["createHandler","ttl","fetchFunc","cache","req","res","next","id","parseInt","query","isNaN","Date","now","timestamp","responseWithoutTimestamp","__rest","status","json","result","filteredArray","getFilteredArray","timeDifferenceResult","findLargestTimeDifference","sortByTime","largestDifference","length","response","success","error","range","Object","assign","start","item1","end","item2","arr","averagePrice","reduce","accumulator","currentItem","price","filter","item","sort","a","b","time","getTime","largestDifferenceItem1","largestDifferenceItem2","i","difference","module","exports"],"mappings":"kTAmBA,SAASA,EAAcC,EAAaC,GAClC,MAAMC,EAAyC,CAAA,EAG/C,OAAO,SAAgBC,EAAcC,EAAeC,4CAClD,MAAMC,EAAKC,SAASJ,EAAIK,MAAMF,IAC9B,IAAKG,MAAMH,IAAOA,EAAK,EAAG,CACxB,GAAIJ,EAAMI,IAAOI,KAAKC,MAAQT,EAAMI,GAAIM,WAAaZ,EAAK,CACxD,MAAsBa,2UAAhBC,CAA6CZ,EAAMI,GAAnD,CAAA,cAEN,YADAF,EAAIW,OAAO,KAAKC,KAAKH,EAEtB,CACD,MAAMI,QAAehB,EAAUK,GAEzBY,EAAgBC,EAAiBF,GACjCG,EACJC,EAA0BC,EAAWJ,IACvC,GAC6C,IAA3CE,EAAqBG,mBACrBL,EAAcM,QAAU,EACxB,CACA,IAAIC,EAAW,CACbC,SAAS,EACTC,MAAO,KACPV,OAAQ,CACNW,MAAO,OAGX1B,EAAMI,GAAGuB,OAAAC,OAAAD,OAAAC,OAAA,CAAA,EAAQL,GAAQ,CAAEb,UAAWF,KAAKC,QAC3CP,EAAIW,OAAO,KAAKC,KAAKS,EACtB,KAAM,CACL,IAAIA,EAAW,CACbC,SAAS,EACTC,MAAO,KACPV,OAAQ,CACNW,MAAO,CACLG,MAAOX,EAAqBY,MAC5BC,IAAKb,EAAqBc,SAIhChC,EAAMI,GAAGuB,OAAAC,OAAAD,OAAAC,OAAA,CAAA,EAAQL,GAAQ,CAAEb,UAAWF,KAAKC,QAC3CP,EAAIW,OAAO,KAAKC,KAAKS,EACtB,CACF,MACCrB,EAAIW,OAAO,KAAKC,KAAK,CACnBU,SAAS,EACTC,MAAO,uBACPV,OAAQ,UAIhB,wDAEa,MAAAE,EAAoBgB,IAC/B,MAAMC,EACJD,EAAIE,QACF,CAACC,EAAaC,IAAgBD,EAAcC,EAAYC,OACxD,GACEL,EAAIX,OACV,OAAOW,EAAIM,QAAQC,GAASA,EAAKF,MAAQJ,GAAa,EAG3Cd,EAAca,GAClBA,EAAIQ,MAAK,CAACC,EAAGC,IAAMD,EAAEE,KAAKC,UAAYF,EAAEC,KAAKC,YAGzC1B,EACXc,IAEA,IAAIZ,EAAoB,EACpByB,EAAyBb,EAAI,GAAGW,KAChCG,EAAyBd,EAAI,GAAGW,KAEpC,IAAK,IAAII,EAAI,EAAGA,EAAIf,EAAIX,OAAQ0B,IAAK,CACnC,MAAMC,EAAahB,EAAIe,GAAGJ,KAAKC,UAAYZ,EAAIe,EAAI,GAAGJ,KAAKC,UACvDI,EAAa5B,IACfA,EAAoB4B,EACpBH,EAAyBb,EAAIe,EAAI,GAAGJ,KACpCG,EAAyBd,EAAIe,GAAGJ,KAEnC,CAED,MAAO,CACLvB,oBACAS,MAAOgB,EACPd,MAAOe,EACR,EAIHG,OAAOC,QAAUtD"}